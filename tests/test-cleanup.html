<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµ‹è¯•é¡µé¢å¸è½½æ¸…ç†</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .status {
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
      }
      .console-log {
        background: #000;
        color: #00ff00;
        padding: 10px;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>æµ‹è¯•é¡µé¢å¸è½½æ¸…ç†åŠŸèƒ½</h1>

    <div class="status">
      <h3>æ´»è·ƒä»»åŠ¡çŠ¶æ€:</h3>
      <p>RAG ä»»åŠ¡: <span id="rag-tasks">[]</span></p>
      <p>Prompt ä»»åŠ¡: <span id="prompt-tasks">[]</span></p>
    </div>

    <div>
      <button onclick="addRagTask()">æ·»åŠ  RAG ä»»åŠ¡</button>
      <button onclick="addPromptTask()">æ·»åŠ  Prompt ä»»åŠ¡</button>
      <button onclick="clearTasks()">æ¸…ç©ºä»»åŠ¡</button>
      <button onclick="testCleanup()">æµ‹è¯•æ¸…ç†</button>
    </div>

    <div>
      <h3>æµ‹è¯•è¯´æ˜:</h3>
      <ol>
        <li>ç‚¹å‡»"æ·»åŠ ä»»åŠ¡"æŒ‰é’®åˆ›å»ºä¸€äº›æ¨¡æ‹Ÿä»»åŠ¡</li>
        <li>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„æ§åˆ¶å°</li>
        <li>å°è¯•å…³é—­å½“å‰æ ‡ç­¾é¡µæˆ–åˆ·æ–°é¡µé¢</li>
        <li>è§‚å¯Ÿæ˜¯å¦æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯å’Œæ§åˆ¶å°æ—¥å¿—</li>
      </ol>
    </div>

    <div>
      <h3>æ§åˆ¶å°æ—¥å¿—:</h3>
      <div id="console-output" class="console-log"></div>
    </div>

    <script>
      // æ¨¡æ‹Ÿ activeTasks çŠ¶æ€
      let activeTasks = { rag: [], prompt: [] };

      // æ¨¡æ‹Ÿæ¸…ç†è­¦å‘Šæ¶ˆæ¯
      const CLEANUP_WARNING_MESSAGE =
        "å…³é—­é¡µé¢å°†åˆ é™¤æ‰€æœ‰åˆ›å»ºçš„è¯„ä¼°ä»»åŠ¡ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ";

      // æ›´æ–°æ˜¾ç¤º
      function updateDisplay() {
        document.getElementById("rag-tasks").textContent = JSON.stringify(
          activeTasks.rag
        );
        document.getElementById("prompt-tasks").textContent = JSON.stringify(
          activeTasks.prompt
        );
      }

      // æ·»åŠ åˆ°æ§åˆ¶å°æ—¥å¿—æ˜¾ç¤º
      function addLog(message) {
        const output = document.getElementById("console-output");
        const timestamp = new Date().toLocaleTimeString();
        output.innerHTML += `[${timestamp}] ${message}<br>`;
        output.scrollTop = output.scrollHeight;
        console.log(message);
      }

      // æ¨¡æ‹Ÿæ·»åŠ ä»»åŠ¡
      function addRagTask() {
        const taskId = `rag-${Date.now()}`;
        activeTasks.rag.push(taskId);
        updateDisplay();
        addLog(`âœ… Added RAG task: ${taskId}`);
      }

      function addPromptTask() {
        const taskId = Math.floor(Math.random() * 1000);
        activeTasks.prompt.push(taskId);
        updateDisplay();
        addLog(`âœ… Added Prompt task: ${taskId}`);
      }

      function clearTasks() {
        activeTasks = { rag: [], prompt: [] };
        updateDisplay();
        addLog("ğŸ§¹ Cleared all tasks");
      }

      // æ¨¡æ‹Ÿæ¸…ç†å‡½æ•°
      async function cleanupActiveTasks() {
        addLog(
          "ğŸ§¹ Starting cleanup - activeTasks: " + JSON.stringify(activeTasks)
        );

        // æ¨¡æ‹Ÿåˆ é™¤ RAG ä»»åŠ¡
        if (activeTasks.rag.length > 0) {
          addLog(
            "ğŸ—‘ï¸ Cleaning up RAG tasks: " + JSON.stringify(activeTasks.rag)
          );
          for (const taskId of activeTasks.rag) {
            addLog(`ğŸ“¤ Deleting RAG task: ${taskId}`);
            // æ¨¡æ‹Ÿ API è°ƒç”¨å»¶è¿Ÿ
            await new Promise((resolve) => setTimeout(resolve, 100));
            addLog(`âœ… Successfully deleted RAG task: ${taskId}`);
          }
        }

        // æ¨¡æ‹Ÿåˆ é™¤ Prompt ä»»åŠ¡
        if (activeTasks.prompt.length > 0) {
          addLog(
            "ğŸ—‘ï¸ Cleaning up Prompt tasks: " + JSON.stringify(activeTasks.prompt)
          );
          for (const taskId of activeTasks.prompt) {
            addLog(`ğŸ“¤ Deleting Prompt task: ${taskId}`);
            // æ¨¡æ‹Ÿ API è°ƒç”¨å»¶è¿Ÿ
            await new Promise((resolve) => setTimeout(resolve, 100));
            addLog(`âœ… Successfully deleted Prompt task: ${taskId}`);
          }
        }

        activeTasks = { rag: [], prompt: [] };
        updateDisplay();
        addLog("ğŸ‰ Cleanup completed successfully");
      }

      function testCleanup() {
        cleanupActiveTasks();
      }

      // è®¾ç½®é¡µé¢å¸è½½äº‹ä»¶ç›‘å¬å™¨
      window.addEventListener("beforeunload", (event) => {
        if (activeTasks.rag.length > 0 || activeTasks.prompt.length > 0) {
          addLog("âš ï¸ beforeunload triggered - showing warning");
          // æ­£ç¡®è®¾ç½® returnValue ä»¥æ˜¾ç¤ºè­¦å‘Šæ¶ˆæ¯
          event.preventDefault();
          event.returnValue = CLEANUP_WARNING_MESSAGE;
          return CLEANUP_WARNING_MESSAGE;
        }
      });

      window.addEventListener("unload", () => {
        addLog("ğŸšª unload triggered - starting cleanup");
        cleanupActiveTasks();
      });

      // åˆå§‹åŒ–æ˜¾ç¤º
      updateDisplay();
      addLog("ğŸ“„ Test page loaded");
    </script>
  </body>
</html>
